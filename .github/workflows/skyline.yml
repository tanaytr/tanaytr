name: Generate 2025 Skyline City

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC (auto-updates forever)
  workflow_dispatch:    # Manual trigger for now

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write     # To commit files

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
            && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
            && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
            && sudo apt update \
            && sudo apt install gh -y

      - name: Install gh-skyline extension
        run: gh extension install github/gh-skyline

      - name: Generate 2025 skyline (ASCII art + STL)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Authenticate CLI non-interactively
          gh config set -h github.com token ${{ secrets.GITHUB_TOKEN }}
          # Generate ASCII art (for README embed) and STL (for 3D link)
          gh skyline generate --year=2025 --art-only --output skyline-2025-ascii.txt
          gh skyline generate --year=2025 --output skyline-2025.stl

      - name: Commit to skyline branch (with fallback placeholder)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update 2025 skyline city ğŸ™ï¸"
          branch: skyline-2025
          create_branch: true
          file_pattern: |
            skyline-2025-ascii.txt
            skyline-2025.stl
        env:
          # Fallback: If no output (low activity), create placeholder
          CI: true
